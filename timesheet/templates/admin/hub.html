{% extends 'theme/base.html' %}
{% load static %}
{% block content %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{% static 'admin/css/graficos.css' %}">
{% endblock %}

<main>

<div class="chart-filter">

  <h2>Filtro Por Hora</h2>

  <div class="date-filter">

    <div class="input-group">
        <label for="dataInicio">Data Inicial:</label>
        <input type="date" id="dataInicio" name="data_inicio" />
    </div>

    <div class="input-group">
        <label for="dataFim">Data Final:</label>
        <input type="date" id="dataFim" name="data_fim" />
    </div>
    <button class="filter-btn" onclick="filtrarAtividades()">Filtrar</button>
    <button type="button" onclick="limparFiltros()" class="filter-btn">Limpar Filtros</button>
    </div>

    <div class="chart-boxes">
        <div class="chart-container">
            <h2>Horas Trabalhadas por Serviço</h2>
            <p><strong>Total de Horas Trabalhadas:</strong> {{ total_horas }}</p>
            <canvas id="servicoChart"></canvas>
        </div>
    
        <div class="chart-container">
            <h2>Detalhes Das Horas</h2>
            <canvas id="barChartAtividades"></canvas>
        </div>
    </div>

</div>
    
</main>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var ctx = document.getElementById("chartColaboradores").getContext("2d");

  // Pegando os dados do Django
  var labels = JSON.parse('{{ labels|safe }}');
  var values = JSON.parse('{{ values|safe }}');

  var myChart = new Chart(ctx, {
      type: "doughnut",  // Tipo do gráfico
      data: {
          labels: labels,
          datasets: [{
              data: values,
              backgroundColor: ["#36A2EB", "#FF6384"], // Azul e Vermelho
              borderWidth: 1
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: {
                  position: "top"
              },
              tooltip: {
                  callbacks: {
                      label: function(tooltipItem) {
                          let total = values.reduce((a, b) => a + b, 0);
                          let percent = ((tooltipItem.raw / total) * 100).toFixed(2);
                          return `${tooltipItem.label}: ${tooltipItem.raw} (${percent}%)`;
                      }
                  }
              }
          }
      }
  });
});
</script>

<!--Gráfico de Barras-->

<script>
  function filtrarAtividades() {
      var dataInicio = document.getElementById("dataInicio").value;
      var dataFim = document.getElementById("dataFim").value;

      if (dataInicio && dataFim) {
          window.location.href = "?data_inicio=" + dataInicio + "&data_fim=" + dataFim;
      }
  }

  document.addEventListener("DOMContentLoaded", function () {
      var ctxAtividades = document.getElementById("barChartAtividades").getContext("2d");

      var labelsAtividades = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
      var valuesAtividades = JSON.parse('{{ atividades_por_dia|safe }}');

      new Chart(ctxAtividades, {
          type: "bar",
          data: {
              labels: labelsAtividades,
              datasets: [{
                  label: "Atividades feitas",
                  data: valuesAtividades,
                  backgroundColor: ["#3498db", "#2ecc71", "#e74c3c", "#f1c40f", "#9b59b6", "#1abc9c", "#ff5733"],
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          stepSize: 1
                      }
                  }
              }
          }
      });
  });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var ctx = document.getElementById("servicoChart").getContext("2d");

        var labels = JSON.parse('{{ servicos_labels|safe }}') || [];
        var values = JSON.parse('{{ servicos_values|safe }}') || [];

        // Verifica se há dados para exibir
        if (labels.length === 0 || values.length === 0) {
            console.warn("Nenhum dado disponível para exibir o gráfico.");
            return;
        }

        new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: labels,
                datasets: [{
                    label: "Horas Trabalhadas",
                    data: values,
                    backgroundColor: ["#3498db", "#2ecc71", "#e74c3c", "#f1c40f", "#9b59b6", "#1abc9c", "#ff5733"],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "bottom"
                    },
                    tooltip: {
                        callbacks: {
                            label: function (tooltipItem) {
                                var totalHoras = tooltipItem.raw;

                                // Converte a parte decimal para minutos e segundos
                                var horas = Math.floor(totalHoras);
                                var minutos = Math.floor((totalHoras - horas) * 60);
                                var segundos = Math.round(((totalHoras - horas) * 60 - minutos) * 60);

                                return `${tooltipItem.label}: ${horas}:${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
<script>
    function limparFiltros() {
        // Obtém a data de hoje e calcula a semana passada
        var hoje = new Date();
        var primeiroDiaSemanaPassada = new Date(hoje);
        primeiroDiaSemanaPassada.setDate(hoje.getDate() - hoje.getDay() - 6); // Segunda-feira da semana passada
        var ultimoDiaSemanaPassada = new Date(primeiroDiaSemanaPassada);
        ultimoDiaSemanaPassada.setDate(primeiroDiaSemanaPassada.getDate() + 6); // Domingo da semana passada

        // Formata para YYYY-MM-DD (padrão dos inputs)
        function formatarData(data) {
            return data.toISOString().split('T')[0];
        }

        // Define os valores padrão
        document.getElementById("dataInicio").value = formatarData(primeiroDiaSemanaPassada);
        document.getElementById("dataFim").value = formatarData(ultimoDiaSemanaPassada);

        // Submete o formulário com os valores padrões
        window.location.href = "?data_inicio=" + formatarData(primeiroDiaSemanaPassada) + "&data_fim=" + formatarData(ultimoDiaSemanaPassada);
    }
</script>


{% endblock %}
